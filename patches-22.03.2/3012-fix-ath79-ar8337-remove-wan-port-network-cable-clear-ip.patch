From ed71a23132bac937335d787203415b01dbc89d2d Mon Sep 17 00:00:00 2001
From: Weiping Yang <weiping.yang@gl-inet.com>
Date: Tue, 21 Mar 2023 05:26:55 -0400
Subject: [PATCH] fix-ar8337-remove-wan-port-network-cable-clear-ip

---
 ...move-wan-port-network-cable-clear-ip.patch | 33 +++++++++++++++++++
 1 file changed, 33 insertions(+)
 create mode 100644 target/linux/ath79/patches-5.10/943-fix-ar8337-remove-wan-port-network-cable-clear-ip.patch

diff --git a/target/linux/ath79/patches-5.10/943-fix-ar8337-remove-wan-port-network-cable-clear-ip.patch b/target/linux/ath79/patches-5.10/943-fix-ar8337-remove-wan-port-network-cable-clear-ip.patch
new file mode 100644
index 0000000000..ef0cc8badf
--- /dev/null
+++ b/target/linux/ath79/patches-5.10/943-fix-ar8337-remove-wan-port-network-cable-clear-ip.patch
@@ -0,0 +1,33 @@
+--- a/drivers/net/phy/ar8216.c
++++ b/drivers/net/phy/ar8216.c
+@@ -2545,6 +2545,8 @@ ar8xxx_phy_read_status(struct phy_device
+ {
+ 	struct ar8xxx_priv *priv = phydev->priv;
+ 	struct switch_port_link link;
++	bool port1_status;
++	port1_status = priv->link_up[1];
+ 
+ 	/* check for switch port link changes */
+ 	ar8xxx_check_link_states(priv);
+@@ -2570,10 +2572,18 @@ ar8xxx_phy_read_status(struct phy_device
+ 	default:
+ 		phydev->speed = 0;
+ 	}
+-	phydev->duplex = link.duplex ? DUPLEX_FULL : DUPLEX_HALF;
++	phydev->duplex = link.duplex ? DUPLEX_FULL : DUPLEX_HALF
++
++	//Execute only when the wan port is down
++	if(port1_status && port1_status != priv->link_up[1]){
++		phydev->link = 0;
++		phydev->state = PHY_NOLINK;
++		netif_carrier_off(phydev->attached_dev);
++	} else {
++		phydev->state = PHY_RUNNING;
++		netif_carrier_on(phydev->attached_dev);
++	}
+ 
+-	phydev->state = PHY_RUNNING;
+-	netif_carrier_on(phydev->attached_dev);
+ 	if (phydev->adjust_link)
+ 		phydev->adjust_link(phydev->attached_dev);
+ 
-- 
2.17.1

