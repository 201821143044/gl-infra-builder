From be73a7f1d66bbec39c5a8b01418d38f85597afeb Mon Sep 17 00:00:00 2001
From: Jianhui Zhao <jianhui.zhao@gl-inet.com>
Date: Wed, 13 Jul 2022 11:47:57 +0800
Subject: [PATCH] ipq807x: support distinguish iPhone eth

Signed-off-by: Jianhui Zhao <jianhui.zhao@gl-inet.com>
---
 .../patches/301-fix-usb-net-ipheth.patch      | 39 +++++++++++++++++++
 1 file changed, 39 insertions(+)
 create mode 100644 feeds/ipq807x/ipq807x/patches/301-fix-usb-net-ipheth.patch

diff --git a/feeds/ipq807x/ipq807x/patches/300-fix-usb-net-ipheth.patch b/feeds/ipq807x/ipq807x/patches/300-fix-usb-net-ipheth.patch
new file mode 100644
index 00000000..0d6a5cde
--- /dev/null
+++ b/feeds/ipq807x/ipq807x/patches/300-fix-usb-net-ipheth.patch
@@ -0,0 +1,39 @@
+Index: linux-4.4.60-qsdk-11f09717303ecd83c3a64e9efe23f25921dc1016/drivers/net/usb/ipheth.c
+===================================================================
+--- linux-4.4.60-qsdk-11f09717303ecd83c3a64e9efe23f25921dc1016.orig/drivers/net/usb/ipheth.c
++++ linux-4.4.60-qsdk-11f09717303ecd83c3a64e9efe23f25921dc1016/drivers/net/usb/ipheth.c
+@@ -52,6 +52,7 @@
+ #include <linux/ethtool.h>
+ #include <linux/usb.h>
+ #include <linux/workqueue.h>
++#include <linux/proc_fs.h>
+ 
+ #define USB_VENDOR_APPLE        0x05ac
+ #define USB_PRODUCT_IPHONE      0x1290
+@@ -497,6 +498,10 @@ static const struct net_device_ops iphet
+ 	.ndo_tx_timeout = ipheth_tx_timeout,
+ };
+ 
++static const struct file_operations proc_fops = {
++	.owner      = THIS_MODULE
++};
++
+ static int ipheth_probe(struct usb_interface *intf,
+ 			const struct usb_device_id *id)
+ {
+@@ -575,6 +580,7 @@ static int ipheth_probe(struct usb_inter
+ 	netif_carrier_off(netdev);
+ 	netif_tx_stop_all_queues(netdev);
+ 	dev_info(&intf->dev, "Apple iPhone USB Ethernet device attached\n");
++	proc_create("iphoneconn", 0644, NULL, &proc_fops);
+ 	return 0;
+ 
+ err_register_netdev:
+@@ -602,6 +608,7 @@ static void ipheth_disconnect(struct usb
+ 	}
+ 	usb_set_intfdata(intf, NULL);
+ 	dev_info(&intf->dev, "Apple iPhone USB Ethernet now disconnected\n");
++	remove_proc_entry("iphoneconn", NULL);
+ }
+ 
+ static struct usb_driver ipheth_driver = {
-- 
2.25.1

