From 44047bc4cc5c925b8dbeb16dbca85409f7817535 Mon Sep 17 00:00:00 2001
From: gl-luochongjun <luochongjun@gl-inet.com>
Date: Fri, 14 Oct 2022 19:28:52 +0800
Subject: [PATCH] target/mediatek: fix poll link state

---
 .../base-files/etc/init.d/gpy211-link-poll    | 32 +++++++++++++++++++
 1 file changed, 32 insertions(+)
 create mode 100755 target/linux/mediatek/base-files/etc/init.d/gpy211-link-poll

diff --git a/target/linux/mediatek/base-files/etc/init.d/gpy211-link-poll b/target/linux/mediatek/base-files/etc/init.d/gpy211-link-poll
new file mode 100755
index 0000000000..9176982646
--- /dev/null
+++ b/target/linux/mediatek/base-files/etc/init.d/gpy211-link-poll
@@ -0,0 +1,32 @@
+#!/bin/sh /etc/rc.common
+# Copyright (C) 2014 OpenWrt.org
+
+START=99
+
+gpy211_link_poll() {
+	old_state=1
+
+	while [ 1 ];
+	do
+		val=$(mii_mgr -g -p 5 -r 18 | awk -F' ' '{print $4}')
+
+		bit10=$(((0x$val >> 10) & 1))
+
+		echo "$bit10" > /var/run/gpy211_state
+
+		[ $bit10 -eq $old_state ] || {
+			old_state=$bit10
+			if [ $bit10 = "0" ];then
+				ifconfig eth0 down
+			else
+				ifconfig eth0 up
+			fi
+		}
+
+		sleep 1
+	done
+}
+
+start() {
+	gpy211_link_poll &
+}
-- 
2.25.1

